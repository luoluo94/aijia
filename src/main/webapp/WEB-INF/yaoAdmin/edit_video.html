<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
</head>
<body>
<div>
    <form  role="form" id="edit-form" style="margin-top: 55px;margin-left: 45px;">
        <input type="hidden" class="form-control" name="id" id="id">
        <label class="inline">
            歌曲名称：<input type="text" class="form-control" name="name" id="name">
        </label>
        <label class="inline">
            歌手名称：<input type="text" class="form-control" name="singer_name" id="singer_name">
        </label>
        <label class="inline">
            歌曲热度：<input type="text" class="form-control" name="hot_index" id="hot_index">
        </label>
        <label>
            音乐主题：<select class="form-control" id="music_theme" name="music_theme">
        </select>
        </label>
        </label>
        <label class="inline">
            上传音乐：<button type="button" class="btn btn-default xiugaibtn">点击上传</button>
            音乐上传速度可能很慢，成功后将会自动存入歌曲地址
        </label>
        <label class="inline">
            歌曲地址：<input type="text" class="form-control" name="video_url" id="video_url" style="width: 650px;">
        </label>
            <button type="button" class="btn btn-default -btn add-btn top20" onclick="save()">保存</button>
            <button type="button" class="btn btn-default -btn back-btn top20" onclick="back()">返回</button>
    </form>
    <form id="file-form">
        <input type="file" class="files" style="opacity: 0;display: none;" accept="audio/mpeg" id="file"/>
    </form>
</div>
</body>
<script type="text/javascript">
    $("#id").val($("#edit_id").val());
    listMusicTheme("music_theme");
    function get(){
        document.getElementById("edit-form").reset();

        $.ajax({
            url: adminPath+"/video/viewById",
            data:{
                id:$("#edit_id").val()
            },
            dataType:"json",
            error:function(){alert("出错了，请稍后再试")},
            success:function(result){
                if(result.issuccess) {
                    $("#name").val(result.data.name);
                    $("#singer_name").val(result.data.singer_name);
                    $("#video_url").val(result.data.video_url);
                    $("#hot_index").val(result.data.hot_index);
                    $("#music_theme").val(result.data.music_theme);
                }else{
                    alert("出错了，请稍后再试")
                }
            }
        });
    }

    function save(){
        if($("#edit-form").valid()){
            $.ajax({
                url: adminPath+"/video/saveOrUpdate",
                data:$("#edit-form").serialize(),
                dataType:"json",
                error:function(){alert("出错了，请稍后再试")},
                success:function(result){
                    if(result.issuccess) {
                        back();
                        alert("操作成功");
                    }else {
                        alert("出错了，请稍后再试")
                    }

                }
            });
        }
    }


    $(".xiugaibtn").click(function () {
        $(".files").click();
    });

    $(".files").change(function(){
        var form = document.getElementById("file-form");//获取到form表单
        var formData = new FormData(form);//创建一个formData对象,将表单中的数据放进去
        for(var i=0; i<$('#file')[0].files.length;i++){//使用for循环将选择的文件一个一个添加(append)到formData对象中
            formData.append('img'+i, $('#file')[0].files[i]);//注意:如果你使用的是jfinal框架这里的key(img)必须是不同的,如果相同的话文件能上传但是拿上传文件名的时候只能拿到一个
        }
        $.ajax({
            url: adminPath+"/upload/uploadVideo",
            type: "POST",
            processData : false,//不处理数据,必须为false
            contentType : false,//不设置内容类型,必须为false
            data: formData,
            success: function(result){
                if(result.issuccess) {
                    $("#video_url").val(result.data);
                }else{
                    alert("出现错误，请稍后再试！");
                }
            },
            dataType:"json",
            error:function(e){
                alert("出现错误，请稍后再试！");
            }

        });
    });

    $(function(){

        $("#edit-form").validate({
            rules: {
                name: {
                    required: true,
                },
                singer_name: {
                    required: true,
                },
                hot_index: {
                    required: true,
                },
                music_theme: {
                    required: true,
                },
                video_url: {
                    required: true,
                }
            },
            messages: {
                name: {
                    required: "请填写歌曲名称",
                },
                singer_name: {
                    required: "请填写歌手名称",
                },
                hot_index: {
                    required: "请填写热度，默认为0",
                },
                music_theme: {
                    required: "请选择音乐主题",
                },
                video_url: {
                    required: "请上传音乐，填写地址",
                }
            }
        });

    });

    if($("#edit_id").val()!='' &&  $("#edit_id").val()!=null){
        get();
    }


</script>
</html>