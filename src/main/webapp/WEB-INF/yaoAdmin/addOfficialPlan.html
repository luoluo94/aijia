<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
</head>
<body>
<div>
    <form  role="form" id="edit-form" style="margin-top: 55px;margin-left: 45px;">
        <input type="hidden" class="form-control" name="my_user_id" id="my_user_id">
        <label>
            官方id:
        <input class="form-control" name="token" id="admin_id" value="5234cb72-c95a-49c9-bd3a-c0d0832f239d"><button type="button" class="btn btn-default" onclick="search_plans()">查询</button>
        </label>

        <label>
            计划：<select class="form-control" id="plan_id" name="plan_id">
        </select>
        </label>
        <label>
        选取头像：<select class="form-control" id="plan_detail_id" name="plan_detail_id"></select>
        </label>
        <div class="details" id="details">

        </div>

            <button type="button" class="btn btn-default -btn add-btn top20" onclick="save()">保存</button>
            <button type="button" class="btn btn-default -btn back-btn top20" onclick="back()">返回</button>
    </form>
    <form id="file-form">
        <input type="file" class="files" style="opacity: 0;display: none;" id="file"/>
    </form>
</div>
</body>
<script type="text/javascript">

    $("#my_user_id").val($("#sign_user_id").val());

    $(".xiugaibtn").click(function () {
        $(".files").click();
    });

    $(".files").change(function(){
        var form = document.getElementById("file-form");//获取到form表单
        var formData = new FormData(form);//创建一个formData对象,将表单中的数据放进去
        for(var i=0; i<$('#file')[0].files.length;i++){//使用for循环将选择的文件一个一个添加(append)到formData对象中
            formData.append('img'+i, $('#file')[0].files[i]);//注意:如果你使用的是jfinal框架这里的key(img)必须是不同的,如果相同的话文件能上传但是拿上传文件名的时候只能拿到一个
        }
        $.ajax({
            url: adminPath+"/upload/uploadSignImage",
            type: "POST",
            processData : false,//不处理数据,必须为false
            contentType : false,//不设置内容类型,必须为false
            data: formData,
            success: function(result){
                if(result.is_success) {
                    $("#photoUrl").val(result.data);
                    $("#share_image").attr("src",result.data);
                }else{
                    alert("出现错误，请稍后再试！"+result.message);
                }
            },
            dataType:"json",
            error:function(e){
                alert("出现错误，请稍后再试！");
            }

        });
    });

    function search_plans(){
        $.ajax({
            url: adminPath+"/plan/listUnOfficialPlans",
            type:"POST",
            data:{
                admin_id:$("#admin_id").val()
            },
            dataType:"json",
            error:function(){return false},
            success:function(result){
                $("#plan_id").empty();
                $("#plan_id").append("<option value=''>未选择</option>");
                $.each(result.data, function (idx, val) {
                    $("#plan_id").append("<option value='" + val["id"] + "'>" + val["title"] + "</option>");
                });
            }
        });
    }

    $("#plan_id").change(function(){
        listPlanDetail($("#plan_id").val());
    });

    function save(){
        if($("#edit-form").valid()){
            $.ajax({
                url: adminPath+"/plan/setPlanOfficial",
                type:'POST',
                data:{
                    plan_id:$("#plan_id").val()
                },
                dataType:"json",
                error:function(){alert("出错了，请稍后再试")},
                success:function(result){
                    if(result.is_success) {
                        back();
                        alert("操作成功");
                    }else {
                        alert("出错了，请稍后再试")
                    }

                }
            });
        }
    }

    function listPlanDetail(planId){
        $.ajax({
            url: adminPath+'/plan/getDetails',
            type:"POST",
            data:{
                plan_id:planId
            },
            dataType:"json",
            error:function(){return false},
            success:function(result){
                console.log(result);
                $("#details").html('');
                var innerHtml='';
                $.each(result.data, function (idx, val) {
                    console.log(val["plan_detail"]);
                    innerHtml+='<div><label class="detail">'+val["sort_index"]+'.'+val["plan_detail"]+'<input  id="name_' + val["id"] + '"/></label></div>';
                });
                console.log(innerHtml);
                $("#details").html(innerHtml);
            }
        });
    }


</script>
</html>